#!/bin/sh

#----------------------------------------------------------------------------
key_in_keys_file() {
    keyfile=$1
    keysfile=$2
    local kikf="false"
    if [ -f ${keyfile} ]; then
        if [ -f ${keysfile} ]; then
            local key=`cat ${keyfile} | cut -d' ' -f1`
            if [ -n "${key}" ]; then
                grep "${key}" ${keysfile} > /dev/null 2>&1
                if [ $? -eq 0 ]; then
                    kikf="true"
                fi
            fi
        fi
    fi
    echo ${kikf}
}

#----------------------------------------------------------------------------
user_known_to_mccurtaind () {
    key_in_keys_file ${USER_KEY} ${MCCURTAIND_KNOWN_KEYS}
}

#----------------------------------------------------------------------------
mccurtaind_known_to_user () {
    key_in_keys_file ${MCCURTAIND_KEY} ${USER_KNOWN_KEYS}
}

#----------------------------------------------------------------------------
add_user_to_known_keys () {
    if [ -f ${USER_KEY} ]; then
        local key=`cat ${USER_KEY}`
        echo ${key} >> ${MCCURTAIND_KNOWN_KEYS}
    fi
}

#----------------------------------------------------------------------------
add_mccurtaind_to_user_known_keys () {
    if [ -f ${MCCURTAIND_KEY} ]; then
        local key=`cat ${MCCURTAIND_KEY}`
        echo ${key} >> ${USER_KNOWN_KEYS}
    fi
}

#----------------------------------------------------------------------------
#  main
#----------------------------------------------------------------------------
export PATH=${PATH}:/usr/local/bin

USER_HOME=`grep ^${SUDO_USER} /etc/passwd | cut -d: -f6`
USER_KEY=${USER_HOME}/.credence/id_ed25519.pub
USER_KNOWN_KEYS=${USER_HOME}/.credence/known_keys
MCCURTAIND_KEY=@prefix@/etc/mccurtaind/id_ed25519.pub
MCCURTAIND_KNOWN_KEYS=@prefix@/etc/mccurtaind/known_keys

#  Create directory for our credence keys if it doesn't exist.
if [ ! -d @prefix@/etc/mccurtaind ]; then
    mkdir @prefix@/etc/mccurtaind
fi                                                                          

# Check for existing mccurtaind key, create if it doesn't exist.
if [ ! -f ${MCCURTAIND_KEY} ]; then
    credence keygen -i mccurtaind@`hostname` -d @prefix@/etc/mccurtaind
fi

# and set up the installation user to use mccurtain.
if [ $(user_known_to_mccurtaind) = "false" ]; then
    add_user_to_known_keys
fi
if [ $(mccurtaind_known_to_user) = "false" ]; then
    add_mccurtaind_to_user_known_keys
fi

# And restart mccurtaind if desired.
. /etc/rc.conf
case ${mccurtaind_enable} in
    [Yy][Ee][Ss])
        /usr/local/etc/rc.d/mccurtaind restart
      ;;
    *)
      ;;
esac
